syntax = "proto3";

package authorization.v1;

option go_package = "github.com/GrishanyaaShustov/CloudStorage-Protos-Service/gen/go/authorization-service;authorizationservicev1";

import "google/protobuf/timestamp.proto";

// Основной сервис авторизации / идентификации.
service AuthorizationService {
  // Регистрация пользователя в системе идентификаций (Kratos).
  rpc Register(RegisterRequest) returns (RegisterResponse);

  // Подтверждение e-mail (если нужно проксировать flow Kratos).
  rpc VerifyEmail(VerifyEmailRequest) returns (VerifyEmailResponse);

  // Логин пользователя по email + password.
  // На выходе – набор OAuth2/OIDC токенов, полученных через Hydra.
  rpc Login(LoginRequest) returns (LoginResponse);

  // Обновление токенов по refresh_token.
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);

  // Явный логаут – отзыв refresh_token / сессии.
  rpc Logout(LogoutRequest) returns (LogoutResponse);

  // Интроспекция access/refresh токена (фасад над Hydra Introspection).
  rpc IntrospectToken(IntrospectTokenRequest) returns (IntrospectTokenResponse);

  // Явный отзыв токена (фасад над Hydra Revocation).
  rpc RevokeToken(RevokeTokenRequest) returns (RevokeTokenResponse);

  // Получение текущего пользователя по access_token
  rpc GetCurrentUser(GetCurrentUserRequest) returns (GetCurrentUserResponse);
}

// -------------------------
// Общие сущности
// -------------------------

// Базовая информация о пользователе.
// user_id – идентификатор Kratos identity.
message User {
  string user_id = 1;
  string login   = 2; // Может быть не уникальным
  string email   = 3;
  bool   email_verified = 4;

  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
}

// Набор OAuth2/OIDC токенов, полученных от Hydra.
message OAuthTokens {
  string access_token  = 1;
  string refresh_token = 2;
  string id_token      = 3;

  // Время жизни access_token в секундах (как возвращает Hydra).
  int64  expires_in    = 4;

  // Обычно "Bearer".
  string token_type    = 5;

  // Выданные scope'ы (через пробел).
  string scope         = 6;
}

// -------------------------
// Регистрация
// -------------------------

message RegisterRequest {
  // Логин может быть не уникальным
  string login    = 1;

  // Уникальный email пользователя – основная точка логина.
  string email    = 2;

  // Пароль в открытом виде, передаётся по TLS;
  // и проксирование в Kratos.
  string password = 3;
}

message RegisterResponse {
  User user = 1;
}

// -------------------------
// Подтверждение email
// -------------------------

// Как именно у Kratos организован flow (link/код/flow_id) – зависит от конфигурации.
// В контракте можно заложить поддержку кода и/или токена.
message VerifyEmailRequest {
  // Код/токен подтверждения из письма.
  string verification_code = 1;

  // Если нужно проксировать какой-то flow_id Kratos.
  string flow_id = 2;
}

message VerifyEmailResponse {
  User user = 1;
}

// -------------------------
// Логин / получение токенов
// -------------------------

message LoginRequest {
  // Логин только по email
  string email    = 1;
  string password = 2;

  // Параметры OAuth2 клиента для общения с Hydra.
  string client_id     = 3;
  string client_secret = 4; // Для public clients может быть пустым.

  // Для PKCE
  string code_verifier = 5;

  // Дополнительные scopes
  string scope         = 6;
}

message LoginResponse {
  User        user   = 1;
  OAuthTokens tokens = 2;
}

// -------------------------
// Обновление токенов
// -------------------------

message RefreshTokenRequest {
  string refresh_token = 1;
  string client_id     = 2;
  string client_secret = 3;
  string scope         = 4; // Может быть пустым – тогда те же scopes.
}

message RefreshTokenResponse {
  OAuthTokens tokens = 1;
}

// -------------------------
// Логаут
// -------------------------

message LogoutRequest {
  // Обычно достаточно refresh_token, чтобы инвалидировать сессию.
  string refresh_token = 1;

  string client_id     = 2;
  string client_secret = 3;
}

message LogoutResponse {
  // Можно вернуть просто success-флаг, чтобы явно сигнализировать состоянием.
  bool success = 1;
}

// -------------------------
// Интроспекция токена
// -------------------------

message IntrospectTokenRequest {
  string token           = 1;
  string token_type_hint = 2; // "access_token" или "refresh_token".
}

message IntrospectTokenResponse {
  // Поле "active" из RFC 7662.
  bool active = 1;

  // Ниже — стандартные поля Introspection Response из OAuth2/OIDC.
  string subject  = 2; // sub – идентификатор пользователя (обычно user_id).
  string client_id = 3;
  string scope    = 4;

  int64 exp       = 5; // unix timestamp.
  int64 iat       = 6;
  int64 nbf       = 7;

  string token_type = 8;

  // Опционально – raw JSON с полной интроспекцией Hydra (для расширяемости).
  string raw = 100;
}

// -------------------------
// Явный отзыв токена
// -------------------------

message RevokeTokenRequest {
  string token           = 1;
  string token_type_hint = 2;
  string client_id       = 3;
  string client_secret   = 4;
}

message RevokeTokenResponse {
  bool success = 1;
}

// -------------------------
// Получение текущего пользователя
// -------------------------

// Обычно backend-сервисы дергают IntrospectToken сами, но полезно иметь
// удобный метод, который объединяет интроспекцию + чтение профиля из Kratos.
message GetCurrentUserRequest {
  // Access token, полученный клиентом.
  string access_token = 1;
}

message GetCurrentUserResponse {
  User user = 1;

  // Можно дополнительно вернуть разобранные клеймы id_token,
  string id_token_raw = 2;
}
